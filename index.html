<!DOCTYPE html>
<html>

<head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>

<body>

    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1920,
            height: 768,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        var currentSec = 120;
        var currentTime = currentSec;
        var count = 0, countdown, info, data, scenes, dataIndex = 0, levelIndex = 0, correctCount = 0, successP, failP, overTitle, vol, bridges, answerArr = [];
        var tmpArr = []
        var game = new Phaser.Game(config);
        var platforms;

        var Bridge = new Phaser.Class({

            Extends: Phaser.Physics.Arcade.Sprite,

            initialize:

                function Bridge(scene, x, y) {
                    Phaser.Physics.Arcade.Sprite.call(this, scene)
                    this.OX = x;
                    this.OY = y;
                    this.selected = false;
                    this.setTexture('bridgepic');
                    this.setScale(0.1)
                    this.setPosition(x, y)
                    this.setOrigin(0);
                    this.setData('A', vol[dataIndex])
                    this.setDepth(1)
                    this.txt = scene.add.text(x + 50, y + 20, vol[dataIndex], { fontSize: '20px', fill: '#fff' }).setDepth(2)


                    scene.physics.world.enableBody(this, 0);

                    this.setInteractive();
                    scene.input.setDraggable(this)
                    scene.input.on('drag', function (pointer, gameObject, dragX, dragY) {
                        if (!gameObject.selected) {
                            gameObject.x = dragX
                            gameObject.y = dragY
                        }


                    })

                    // this.setCollideWorldBounds(true);


                    var tmp = this
                    this.on('pointerup', function (d, e) {
                        console.log(tmp.x, tmp.y)
                        if ((tmp.x >= 500 && tmp.x <= 1400) && (tmp.y >= 150 && tmp.y <= 350) && !tmp.selected) {
                            answerArr.push(tmp.getData('A'))

                            tmp.x = 510 + 150 * ((answerArr.length - 1) % 5)
                            tmp.y = 150 + 100 * Math.floor((answerArr.length - 1) / 5)
                            tmp.selected = true;
                        } else if (!tmp.selected) {
                            tmp.x = x
                            tmp.y = y
                        }

                    }, scene);

                    scene.children.add(this);

                    dataIndex += 1
                },
            reset: function () {
                this.x = this.OX;
                this.y = this.OY;
                this.selected = false;
                answerArr = []
            }



        });
        function preload() {
            this.load.setBaseURL('./');
            
            this.load.json('levelData', 'json/question.json');

            this.load.image('groundL', 'img/groundL.png');
            this.load.image('groundR', 'img/groundR.png');
            this.load.image('river', 'img/river.png');
            this.load.image('bridgepic', 'img/bridgepic.png');
            this.load.image('bridgeBody', 'img/bridgeBody.png');

            this.load.image('person', 'img/person.png');
            this.load.image('personSad', 'img/personSad.png');
            this.load.image('star', 'img/star.png');
            this.load.image('starEmpty', 'img/starEmpty.png');
            this.load.image('audioBtn', 'img/audioBtn.png');
            this.load.image('resetBtn', 'img/makefg.png');
            this.load.image('buildBtn', 'img/buildBtn.png');


            this.load.audio('correct', 'audio/crrect_answer3.mp3');
            this.load.audio('error', 'audio/blip03.mp3');
            this.load.audio('victory', 'audio/Victory.mp3');
            this.load.audio('fail', 'audio/Fail.mp3');
            this.load.audio('destruction', 'audio/destruction1.mp3');

            

        }

        function create() {
            scenes = this;
            data = this.cache.json.get('levelData');
            for (var i=0;i<data.length;i++){
                scenes.load.audio(i + 'audio', 'audio/' + data[i] + '.mp3');

                scenes.load.start()
            }
            this.add.image(1000, 460, 'river');
            this.playBtn = this.add.sprite(40, 110, 'audioBtn').setScale(0.2).setInteractive();
            this.playBtn.on('pointerdown', playTarget);
            successP = this.add.image(900, 600, 'person').setScale(0.5).setDepth(2).setVisible(false)
            failP = this.add.image(900, 600, 'personSad').setScale(0.5).setDepth(2).setVisible(false)
            this.resetBtn = this.add.sprite(1430, 170, 'resetBtn').setScale(0.15).setInteractive();
            this.buildBtn = this.add.sprite(1430, 220, 'buildBtn').setScale(0.2).setInteractive();
            this.resetBtn.on('pointerdown', resetBridge);
            this.buildBtn.on('pointerdown', buildBridge);

            platforms = this.physics.add.staticGroup();
            
            platforms.create(300, 568, 'groundL')
            platforms.create(1600, 568, 'groundR')


            this.bridgeBody = this.add.image(950, 250, 'bridgeBody').setScale(1.5).setVisible(false);
            timedEvent = this.time.addEvent({ delay: 1000, callback: countDown, callbackScope: this });
            overTitle = this.add.text(800, 100, '', { fontSize: '64px', fill: '#fff' })
            countdown = this.add.text(16, 16, 'Time: 120', { fontSize: '32px', fill: '#fff' });
            info = this.add.text(16, 50, '關卡: ' + (levelIndex + 1), { fontSize: '32px', fill: '#fff' });


            bridges = [];


            this.graphics = this.add.graphics();

            this.graphics.fillStyle(0xffffff, 0.6);
            this.graphics.fillRect(500, 150, 900, 200).setDepth(1);


            vol = data[levelIndex].split(' ')

            bridgesTotal = vol.length;
            for (var i = 0; i < bridgesTotal; i++) {
                bridges[i] = new Bridge(scenes, 500 + i * 200, 20);
            }

        }

        function update() {
            for (var i = 0; i < vol.length; i++) {

                bridges[i].txt.x = bridges[i].x + 50;
                bridges[i].txt.y = bridges[i].y + 20;
            }
        }


        function killSprite(sprite) {
            sprite.particles.destroy();
            sprite.disableBody(true, true);
        }

        function killAllBrdige() {
            for (var i = 0; i < bridges.length; i++) {
                bridges[i].txt.setVisible(false);
                bridges[i].disableBody(true, true);
            }

        }

        function countDown() {
            currentSec--;
            count++;
            timedEvent.reset({ delay: 1000, callback: countDown, callbackScope: this, repeat: 1 });
            countdown.setText('Time: ' + currentSec);
            if (count >= currentTime) {
                gameOver()
            }

        };
        function resetBridge(scenes) {
            for (var i = 0; i < vol.length; i++) {
                bridges[i].reset()
            }
        }

        function buildBridge() {
            if (vol.toString() == answerArr.toString()) {
                game.sound.play('correct')
                killAllBrdige()
                correct()
            } else {
                game.sound.play('error')
                resetBridge()
            }

        }
        function correct() {
            correctCount += 1
            if (levelIndex + 1 < data.length) {

                levelIndex += 1
                scenes.time.addEvent({ delay: 500, callback: next, callbackScope: scenes });
            } else {
                gameOver();
            }
        }

        function next() {
            info.setText('關卡: ' + (levelIndex + 1));
            game.sound.play(levelIndex + 'audio');
            vol = data[levelIndex].split(' ')
            dataIndex = 0;
            answerArr = [];
            for (var i = 0; i < vol.length; i++) {
                bridges[i] = new Bridge(scenes, 500 + i * 200, 20);
            }
        }

        function gameOver() {
            killAllBrdige();
            timedEvent.destroy();
            switch (correctCount) {
                case 0:
                    fail()
                    drawStar(0)
                    break;
                case 1: case 2:
                    success()
                    drawStar(1)
                    break;
                case 3: case 4:
                    success()
                    drawStar(2)
                    break;
                default:
                    success()
                    drawStar(3)
                    break;
            }
        }

        function success() {
            game.sound.play('victory')
            successP.setVisible(true)
            overTitle.setText('Clear')
            scenes.bridgeBody.setVisible(true)
            scenes.graphics.setVisible(false)
            scenes.resetBtn.setVisible(false)
            scenes.buildBtn.setVisible(false)
        }

        function fail() {

            game.sound.play('fail')
            failP.setVisible(true)
            overTitle.setText('Fail')
            scenes.graphics.setVisible(false)
            scenes.resetBtn.setVisible(false)
            scenes.buildBtn.setVisible(false)
        }

        function drawStar(n) {
            for (var i = 0; i < n; i++) {
                scenes.add.image(700 + i * 200, 300, 'star')
            }
            for (var i = n; i < 3; i++) {

                scenes.add.image(700 + i * 200, 300, 'starEmpty')
            }
        }
        function playTarget() {
            game.sound.play(levelIndex + 'audio');
        }
    </script>

</body>

</html>